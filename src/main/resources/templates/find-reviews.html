<!DOCTYPE html>
<html th:replace="~{layout :: layout(~{::title}, ~{::#detail}, false)}"
      xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Cloudy Book Club - Find A Book Review</title>
        <meta charset="utf-8">
        <link rel="stylesheet" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
        <link rel="stylesheet" href="../static/css/tom-select.css" th:href="@{/css/tom-select.css}">
        <link rel="stylesheet" href="../static/css/books-app.css" th:href="@{/css/books-app.css}">
    </head>
    <body>

        <div id="detail" hx-boost="false">
            <h2>Find a book review</h2>
            <div class="row">
                <div class="col-sm mb-4">
                    <h3 class="finder-header">Find Reviews By Rating</h3>
                    <select id="select-by-rating" class="finder-control" data-placeholder="Select a review rating" autocomplete="off"
                        hx-target="#cloudy-find-by-results" hx-get="/find?pagenum=1" name="rating" hx-push-url="true">
                        <optgroup id="select-by-rating-options" th:fragment="cloudy-find-by-ratings-options">
                            <option th:each="rating : ${ratings}"
                                    th:value="${#strings.toLowerCase(rating)}"
                                    th:text="${#strings.capitalize(#strings.toLowerCase(rating))}">Great</option>
                        </optgroup>
                    </select>
                </div>
                <div class="col-sm mb-4">


                </div>
                <div class="col-sm mb-4">


                </div>

                <hr class="page-separator">

                <div id="cloudy-find-by-results" th:fragment="cloudy-find-by-results">
                    <div th:if="${pageOfBooks != null}">
                        <h3>Books matching your selection</h3>
                        <p th:replace="~{components/books-table :: cloudy-books-table}">
                            The <a href="./components/books-table.html">table</a> of matching books will go here.</p>
                    </div>
                    <div th:if="${pageOfBooks == null}">
                        <p>Please enter your search criteria into one of the controls above. Matching results will be displayed here.</p>
                    </div>
                </div>

            </div>

            <script src="../../static/js/tom-select.complete.min.js" th:src="@{/js/tom-select.complete.min.js}"></script>
            <script>
                htmx.onLoad(function(elt) {
                    // Look up all elements with the tomselect class on it within the element
                    var allSelects = htmx.findAll(elt, ".finder-control");
                    for ( select of allSelects ) {
                        console.log(select);
                        if (!select.tomselect) {
                            console.log('Running TomSelect init');
                            try {
                                new TomSelect("#select-by-rating",{
                                    create: false,
                                    highlight: true,
                                    allowEmptyOption: true,
                                    maxItems: 1,
                                    items: [],
                                    plugins: ['clear_button'],
                                    sortField:[{field:'$order'},{field:'$score'}]
                                });
                            } catch (err) {
                                console.log('Ignoring already initted error');
                            }
                        } else {
                            console.log('Skipping - already TomSelect init');
                        }
                    }
                });
            </script>

        </div>

    </body>
</html>
